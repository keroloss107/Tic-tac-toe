name: CD - Build, Package, and Release

on:
  push:
    branches:
      - main
      - release

jobs:
  release:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.9.1
      QT_DIR: C:\Qt\6.9.1\msvc2022_64
      BUILD_TYPE: Release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Set up Qt path
      run: echo "$env:QT_DIR\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Auto-generate version
      run: echo "VERSION=v1.0.${{ github.run_number }}" >> $env:GITHUB_ENV

    - name: Configure CMake project
      run: cmake -S . -B build -DCMAKE_PREFIX_PATH="${{ env.QT_DIR }}" -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build with MSVC
      run: cmake --build build --config $env:BUILD_TYPE

    - name: Run windeployqt
      run: |
        $qtDeploy = "${{ env.QT_DIR }}\bin\windeployqt.exe"
        & $qtDeploy --release --dir build\Release build\Release\Tictactoe_Project.exe

    - name: Prepare release folder
      run: |
        mkdir packaged
        Copy-Item build\Release\* -Recurse -Destination packaged

    - name: Create ZIP Archive
      run: Compress-Archive -Path packaged -DestinationPath tictactoe-release.zip

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ env.VERSION }}
        tag_name: ${{ env.VERSION }}
        files: tictactoe-release.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
